# 计算机组成原理

主要参考：

[计算机组成原理（哈工大刘宏伟）](http://www.feemic.cn/mooc/icourse163/1205914219)

唐朔飞 《计算机组成原理》（第二版）

[冉冉云 计算机体系结构](https://blog.csdn.net/gzxb1995/category_9814748.html)

## 计算机系统概论

### 计算机系统简介

#### 计算机软硬件概念

计算机系统

1. 硬件：计算机的实体：如主机、外设
2. 软件：具有各类特殊功能的信息（程序）组成
   1. 系统软件：用来管理整个计算机系统
      1. 语言处理程序（编译、链接）
      2. 操作系统
      3. 服务性程序
      4. 数据库管理系统
      5. 网络软件
   2. 应用软件：按任务需要编写的程序

#### 计算机系统的层次结构

1. 物理结构抽象

   ![image-20220625092855877](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220625092903.png)

   自底向上地来看：

   1. Physics 物理抽象，电子设备依靠电子的移动进行工作。可以使用 量子 机制，和麦克斯韦方程进行描述。
   2. Devices 电子元件，利用电子在不同物质中的移动特征来构建不同的电子元件，其具有不同的电压电流特征用以描述。
   3. Analog Circuits 模拟电路，利用基本的电子元件构建放大器，滤波器等部件。
   4. Digital Circuits 数字电路，利用模拟电路层进一步构建与非门等。
   5. Logic 逻辑层，利用数字电路进行加法器和存储器的实现。
   6. Microarchitecture 微体系(架构)结构层，具有执行单元和控制单元

2. 程序员角度

   ![image-20220625094958199](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220625094958.png)

### 计算机的基本组成

#### 冯·诺依曼计算机的特点

1. 计算机由五大部件（运算器、控制器、存储器、输入设备和输出设备）组成
2. 指令和数据以同等地位**存于存储器**，可按地址寻访
3. 指令和数据用二进制表示
4. 指令由操作码和地址码组成
5. 存储程序（核心特征）
6. 以运算器为中心

#### 冯·诺依曼计算机的硬件图

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220625101051.png" alt="image-20220625101051177" style="zoom:80%;" />

+ 实线表示数据通路
+ 虚线表示控制和状态反馈
+ 运算器：核心，算术运算与逻辑运算
+ 存储器：存放数据和程序
+ 控制器：指挥控制程序的运行
+ 输入设备：将信息转化为机器能识别的形式
+ 输出设备：将结果转化为人能识别的形式

#### 冯·诺依曼计算机的结构改进

以存储器为中心的计算机硬件框图

![image-20220625101628906](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220625101628.png)

其中，运算器（ALU）和控制器（CU）可以组成 CPU 。存储器可以进一步分为主存和辅存。主存和CPU可以进一步构成主机。输入设备和输出设备统称为I/O设备，主机和I/O设备统称为硬件。则给出

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220625103446.png" alt="image-20220625103446906" style="zoom:80%;" />

#### 系统复杂性管理的方法

1. 层次化（Hierachy）：将被设计的系统划分为多个模块或子模块
2. 模块化（Modularity）：有明确定义（well-defined）的功能和接口
3. 规则性（regularity）：模块符合某些通用标准，使其更容易被重用

#### 计算机的工作步骤

1. 建立数学模型
2. 确定计算方法
3. 编写解题程序

给例子：计算$a x^{2}+b x+c=(a x+b) x+c$

1. 从问题来看需要**加法指令**和**乘法指令**

2. 还需要取出数字并放置到累加器中的**取数指令**，和读取结果并放置到存储器中的**读取指令**

3. 最后是显示或者打印的**打印指令**，以及停机指令

4. 计算

    	取 x 至运算器中
    	乘以 a 在运算器中
    	加 b 在运算器中
    	乘以 x 在运算器中
    	加 c 在运算器中

#### 指令格式

都使用16位长度的指令由6位操作码和8位地址码构成，[] 表示在寄存器中保存的内容

1. 取数指令

   取数 a，[a] –> ACC

   000001 0000001000，前六位表示取数指令，后十位表示地址8

2. 存数指令

   存数 b，[ACC] –> b

3. 加法指令

   加数 c，[ACC] + [c] –> [ACC]

4. 乘法指令

   乘数 d，[ACC] * [d] –> [ACC]

5. 打印指令

   $\sigma$ ，[$\sigma$] –> 打印机

6. 停机指令

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220625110202.png" alt="image-20220625110202631" style="zoom:67%;" />



#### 存储器的基本组成

上面我们知道，**指令**和**数据**都保存在存储器当中。**存储器**的主要部分是**存储体，MAR，MDR**

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220625161002.png" alt="image-20220625161002215" style="zoom:67%;" />

+ **存储体**又有若干**存储单元**构成，**存储单元**又由若干**存储元件**（0/1）构成。 

+ 存储单元：存放一串二进制代码，即**存储字**
+ 存储字长：存储字的长度（位数）
+ 存储单元**按照地址寻址**
+ MAR：存储器**地址寄存器**，**保存了存储单元的地址**，MAR的位数反映了存储单元的个数。**即存储单元个数是$2^{n_{MAR}}$**。
+ MDR：存储器**数据寄存器**，MDR的位数表示该存储器的**存储字长**，即**存储字长是**$n_{MDR}$
+ MAR 就像存储器的入口，其接受某个地址作为寻找请求。存储器找到后将其地址中的**内容**交给存储器出口MDR

#### 运算器的基本组成



![image-20220625162012087](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220625162012.png)

ALU：Arithmetic Logic Unit，**算术逻辑运算单元**，运算器中完成算术逻辑运算的逻辑部件

ACC：Accumulator，**累加器**，运算器中运算前存放操作数、运算后存放运算结果的寄存器

MQ：Multiplier-Quotient Register，**乘商寄存器**，乘法运算时存放乘数、除法时存放商的寄存器

X：此字母没有专指的缩写含义，可以用作任一部件名，在此表示操作数寄存器，即运算器中工作寄存器之一，用来**存放操作数**

例：加法操作过程，设加法指令操作码为000001，加数的地址为M

1. 初态：ACC中已经存放好了被加数
2. [M] –> X
3. [ACC] + [X] –> ACC

例2：减法操作过程，设减法指令操作码为000010，减数的地址为M

	1. 初态：ACC中已经存放好了被减数
	1. [M] –> X
	1. [ACC] - [X] –> ACC

例3：乘法操作过程，设乘法指令操作码为000011，乘数的地址为M

1. 初态：ACC中已经存放好了被乘数
2. [M] –> MQ
3. [ACC] –> X
4. 0 –> ACC
5. [ACC] \* [X] –> ACC//MQ

例4：除法操作过程，设触发指令操作码为000111，除数的地址为M

1. 初态：ACC中已经存放好了被除数
2. [M] –> X
3. [ACC] / [X] –> MQ，余数在ACC中

#### 控制器的基本组成

控制器由PC、IR与CU组成

控制器用以解释指令并保证指令按照正确的次序执行，下面来看完成一条指令需要三个大步骤：

1. 取指令，**PC（程序计数器）**存放当前欲执行指令的地址， 具有计数功能：（PC）+ 1 –> PC
2. 分析指令，**IR（指令寄存器）**存放当前欲执行的指令
3. 执行指令，**CU**

例：完成一条**取数指令**的过程

![image-20220625165601107](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220625165601.png)

1. 取指令
   1. PC 把指令的地址给MAR 
   2. MAR 在控制器的控制之下，根据地址寻找指定的存储单元
   3. 存储体把指定的存储单元中的指令取出送入 MDR
   4. MDR 取出的指令送入 IR
2. 分析指令
   1. IR 中的操作码部分送给 CU，由 CU 根据指令开始执行操作
3. 执行指令
   1. IR 中的地址码部分送给 MAR
   2. MAR 在控制器的控制之下，根据地址寻找指定的存储单元
   3. 存储体把指定的存储单元中的数据取出送入 MDR
   4. MDR 取出的数据送入ACC，取数完毕

#### 总结

1. 将程序通过输入设备送至计算机
2. 程序首地址 –> PC
3. 启动程序运行
4. 取指令PC→MAR→M→MDR→IR，(PC)+1→PC
5. 分析指令OP(IR)→CU
6. 执行指令AD(IR)→MAR→M→MDR→ACC
7. ……
8. 打印结果
9. 停机

## 系统总线

### 总线的基本概念

> **总线**（Bus）是指计算机组件间规范化的交换数据的方式，即以一种通用的方式为各组件提供数据传送和控制逻辑。从另一个角度来看，如果说[主板](https://zh.wikipedia.org/wiki/主機板)（Mother Board）是一座城市，那么总线就像是城市里的公共汽车（bus），能按照固定行车路线，传输来回不停运作的[比特](https://zh.wikipedia.org/wiki/位元)（bit）。这些线路在同一时间内都仅能负责传输一个比特。因此，必须同时采用多条线路才能发送更多资料，而总线可同时传输的资料数就称为宽度（width），以比特为单位，总线宽度愈大，传输性能就愈佳。总线的[带宽](https://zh.wikipedia.org/wiki/頻寬)（即单位时间内可以传输的总资料数）为：总线带宽 = 频率×宽度（Bytes/sec）

#### 为什么使用总线

| 连接方式     | 硬件资源             | 可扩展性                                         |
| ------------ | -------------------- | ------------------------------------------------ |
| 两两单独连接 | 占用引脚多，连线复杂 | 需要现有设备提供与新设备之间的接口，扩展起来麻烦 |
| 总线式连接   | 占用引脚少，连线简单 | 只需将新设备挂到总线，扩展方便                   |

![为什么要使用总线](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BA%BF.png)

#### 总线上信息的传输

首先，**在任意时刻一条总线只能有一对部件进行信息传输**

总线信息传输方式可以分为**串行传输**和**并行传输**，字面意思来看，串行就是数据是一位一位的发送**，**并行就是数据一组一组的发送。以直觉来看，并行应该是比串行传输速率高的，但事实上现在大部分的芯片都选择串行传输

>**并行总线由于是多个数据同时传输，需要考虑数据的协同性，这就导致了并行传输的频率不能做的很高**。相对的，串行总线只有一条链路，就可以把频率做的很高，提高传输速度，速度提高了就能够弥补一次只能传输一个数据的缺陷。
>
>此外，**并行总线两根相邻的链路其数据是同时传输的**，这就会导致它们彼此之间会产生**严重干扰**，并行的链路越多，干扰越强。因此并行总线需要加强抗干扰的能力，否则传输过程中数据就可能被损坏。如果传输过程中数据故障了，就需要重新对齐数据再传输。而串行总线如果一个数据出错了，只需要重新传输一次就好了，由于串行总线频率高，很快就可以把错误数据重新传输过去。
>
>再次，由于**并行总线是多链路一块传输数据**，就需要很多线，接口需要很多针脚，老式计算机里的并行接口做得很大，接线比较宽，针脚非常多。这样一来装机也很麻烦，因为走线不方便、接口体积很大。

### 总线的分类

#### 根据总线位置进行分类

1. 片内总线：芯片内部的总线
2. 系统总线：计算机各部件的信息传输
   1. 数据总线：双向，与机器字长、存储字长相关
   2. 地址总线：单向，与存储地址、I/O地址相关
   3. 控制总线：
      + 有出：中断请求、总线请求
      + 存储器读、存储器写、总线使用权许可、中断确认
3. 通信总线：用于 计算机系统之间 或 计算机系统 与 其他系统。
   1. 串行传输
   2. 并行传输

### 总线特性及性能指标

#### 总线特性

| 特性分类 | 含义                                 |
| -------- | ------------------------------------ |
| 机械特性 | 尺寸、形状、引脚数、引脚的排列顺序等 |
| 电气特性 | 传输方向、有效电平范围等             |
| 功能特性 | 每根线的功能，如地址、数据、控制等   |
| 时间特性 | 时钟频率、信号的时序关系等           |

#### 性能指标

1. 总线宽度：数据线的根数，根数越多，同时传输的位数就越多
2. 标准传输率：每秒传输的最大字节数（MBps）
3. 时钟类型：同步、不同步
4. 总线复用：地址线和数据线**复用**，以减少芯片的管脚数
5. 信号线数：地址线、数据线和控制线的总和
6. 总线控制方式：突发、自动、仲裁、逻辑、计数
7. 其他指标：负载能力

#### 总线标准

![image-20220627192109975](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E6%80%BB%E7%BA%BF%E6%A0%87%E5%87%86.png)

顺便一提，现代总线比如雷电4标准已经到 40 Gbps，所以总线标准也是计算机的性能瓶颈之一。

### 总线结构

#### 单总线结构

![单总线结构](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E5%8D%95%E6%80%BB%E7%BA%BF%E7%BB%93%E6%9E%84.png)

+ 存在主线争用问题
+ 时间延迟高

#### 多总线结构

1. 面向CPU的双总线结构

   ![面向CPU的双总线结构](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220627185027109.png)

   + 考虑到**指令**和**数据**都来自主存，所以用单独的M总线保证其交换速度
   + 假设主存要与I/O设备信息传输，就不得不经过CPU，会打乱CPU的信息交换任务

2. 面向存储器的双总线结构

   ![面向存储器的双总线结构](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E9%9D%A2%E5%90%91%E5%AD%98%E5%82%A8%E5%99%A8%E7%9A%84%E5%8F%8C%E6%80%BB%E7%BA%BF%E7%BB%93%E6%9E%84.png)

   + 从主存发出两条总线：存储总线和系统总线
   + CPU和主存也保留了专用总线
   + CPU也可以直接与I/O设备交互
   + 目前还不能做到主存同时使用两根总线

3. 使用通道

   ![通道双主线](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E9%80%9A%E9%81%93%E5%8F%8C%E4%B8%BB%E7%BA%BF%E7%BB%93%E6%9E%84.png)

   + 一般来说通道有自己的控制器，指令等

4. 三总线结构

   ![三总线结构](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E4%B8%89%E6%80%BB%E7%BA%BF%E7%BB%93%E6%9E%84.png)

   + 在面向CPU的双总线结构上，将I/O设备分为高速和低速
   + 将高速设备通过新的DMA总线与内存进行直接地信息交换

5. 三总线结构-2

   ![三总线结构2](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E4%B8%89%E6%80%BB%E7%BA%BF%E7%BB%93%E6%9E%842)

   + 由于内存的进步较于CPU缓慢，容易成为计算机的瓶颈点。所以使用Cache对内存中常用的指令预先读取，然后单独与CPU连接一条局部总线
   + 系统总线通过一个扩展总线接口连接扩展总线，但这样会影响外部设备的传输速率

6. 四总线结构

   ![四总线结构](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E5%9B%9B%E6%80%BB%E7%BA%BF%E7%BB%93%E6%9E%84.png)

   + 在三总线-2的基础上将外设分为高速和低速

### 总线控制

总线控制主要解决两个问题：多设备同时申请使用总线的判定（总线判优控制/仲裁）和设备占用总线中保证通讯的正确性（总线通信控制）

#### 总线判优控制

根据组件在总线中的功能可以分为总设备（模块）和从设备（模块）

主设备：对总线有控制权，可以发出占用总线的申请

从设备：没有控制权，只能响应主设备发出的申请

集中式仲裁：把总线的判优逻辑放在一个部件中，根据查询方式不同，又可以分为：**链式查询、计数器定时查询和独立请求方式**

分布式仲裁：总线的仲裁逻辑分散在与总线连接的各主设备上。典型的例子有**以太网**，以太网上接入的各台计算机都可以发起通信，为避免无序竞争，它们都需要遵循以太网的仲裁逻辑，即**载波侦听/冲突检测**。

#### 链式查询

![链式查询](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E9%93%BE%E5%BC%8F%E6%9F%A5%E8%AF%A2.png)

+ 地址线：从设备查找
+ 数据线：数据传输
+ BR 总线：各接口向总线控制部件提出占用请求
+ BG 总线：总线控制部件**链式地**查询哪个I/O接口提出了占用请求（碰到就停止查询）
+ BS 总线：获得总线使用权的接口利用 BR 总线向总线控制部件，发送一个总线忙碌状态以应答

+ 链式查询的顺序就是设备的优先级顺序
+ 优点：结构简单，算法简单，增删设备容易
+ 缺点：BG 对电路故障特别敏感，速度较慢

#### 计数器定时查询

![计时器定时查询](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E8%AE%A1%E6%97%B6%E5%99%A8%E5%AE%9A%E6%97%B6%E6%9F%A5%E8%AF%A2.png)

+ 设备地址线：由总线控制部件的**计数器**发出信号，通过这个地址来查找某个设备是否发出总线请求
+ 计数器：各接口向总线控制部件通过 BR 提出占用请求。控制器接受到请求并成功通过后就会启动计数器（初值为0或者某个地址），计数器的值通过设备地址线向外输出，查询接口为初值的I/O接口。如果没有提出，则计数器++后重复查询，直到找到提出的I/O接口，并用 BR 进行应答。
+ 优点：优先级是优先级较为灵活，比如通过软件的方式设定初值，那么优先级也就随之改变了

#### 	独立请求方式

![独立请求方式](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E7%8B%AC%E7%AB%8B%E8%AF%B7%E6%B1%82%E6%96%B9%E5%BC%8F.png)

+ 任何一个I/O接口都增加了两条线 BR BG
+ 排队器：通过软件的方式在总线控制部件中动态地调整优先级
+ 缺点：连接复杂

#### 总线通信控制

总线传输周期：完成一次传输需要的时间

- 申请分配：判优问题
- 寻址阶段：主设备向从设备给出地址和命令
- 传输阶段：主设备和从设备交换数据
- 结束阶段：主设备撤销相关信息

方式：

| 通信方式   | 特点                                                         |
| ---------- | ------------------------------------------------------------ |
| 同步通信   | 统一定宽定距的时标控制数据传输                               |
| 异步通信   | 无统一时标，采用应答方式。主设备发出请求（命令），从设备应答，进而完成数据交换 |
| 半同步通信 | 引入等待信号，解决不同速度的两个设备之间的通讯，同步异步结合 |
| 分离式通信 | 不在等待时占据总线，提高总线通信的效率                       |

#### 同步通信

1. 同步通信输入

  ![同步通信](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E5%90%8C%E6%AD%A5%E9%80%9A%E4%BF%A1.png)

  + 假设一次数据传输使用了四个时钟周期
  + $T_1$的上升沿之前：主设备发出地址信号并持续
  + $T_2$的上升沿之前：给出读命令
  + $T_3$的上升沿之前：从设备需要将需要数据发送到数据线上
  + $T_4$的上升沿之前：撤销数据、撤销读命令
  + $T_4$结束之前：撤销地址

2. 同步通信输出

   ![image-20220627210825638](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E5%90%8C%E6%AD%A5%E9%80%9A%E4%BF%A1%E8%BE%93%E5%87%BA.png)

   + 假设一次数据传输使用了四个时钟周期
   + $T_1$的上升沿之前：主设备发出地址信号并持续
   + $T_1$的下降沿之前：给出数据到数据线上
   + $T_2$的上升沿之前：给出写命令
   + $T_4$的上升沿之前：撤销数据、撤销写命令
   + $T_4$结束之前：撤销地址

同步通讯特点：需要选择最慢的设备（模块）作为统一通讯的时标，所以通常应用于总线长度短（长度越长频率越低）且各个模块存取时间较为一致。

3. 异步通讯

   异步通讯中根据应答信号是否互锁，即请求和回答信号的建立和撤消是否互相依赖，异步通讯可分为三种类型：非**互锁通讯、半互锁通讯和全互锁通讯**。

   ![异步通讯](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E5%BC%82%E6%AD%A5%E9%80%9A%E8%AE%AF.png)

   + 锁：可以简单理解为状态锁，即保持发送请求这个状态。
   + 不互锁：主设备发出请求信号，经过一段时间（主设备觉得从设备差不多收到）后，就撤销请求信号。从设备同理，接收到请求信号后，经过一段时间，撤销响应信号。**即主设备主观、从设备主观**
   + 半互锁：主设备发出请求信号，直到从设备发出应答信号后才能撤销。而从设备无需等待主设备发出撤销信号，经过一段时间后，撤销响应信号。**即主设备客观、从设备主观**
   + 全互锁：主设备发出请求信号，直到从设备发出应答信号后才能撤销。从设备发出响应信号，知道主设备发出撤销信号后才能撤销响应信号。**即主设备客观、从设备客观**
   + 显然互锁方式不同，传输的速率和可靠程度亦不同

#### 半同步通信

同步特点：发送方用系统时钟前沿**发信号**，接收方用系统时钟后沿**判断、识别**

异步特点：允许不同速度的模块一同工作，增加了一条“等待”响应信号$\overline {WAIT}$

![半同步通信读取](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E5%8D%8A%E5%90%8C%E6%AD%A5%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F.png)

+ $T_1$的上升沿之前：主设备发出地址信号并持续
+ $T_2$的上升沿之前：给出读命令
+ $T_3$的上升沿之前：如果从设备无法准备好数据，则给出$\overline {WAIT}$告知 CPU 进行等待，CPU会插入$T_w$时钟周期。直到某次检测$WAIT$信号为1，则进入$T_3$
+ $T_4$的上升沿之前：撤销读命令、撤销数据
+ $T_4$的上升沿之前：撤销地址

#### 分离式通信

上述三种通信控制方式，准备数据的时候总线都没有被占用，这就造成了浪费。于是乎，我们将一个完整的总线传输周期分为两个小周期，**放弃等待数据这段时间的总线占用**。那么这么判断何时从设备准备好数据了呢？所以在分离式通信中，**每个设备都能作为主设备发出请求信号**，这样从设备就能正常地提供数据以继续流程。

1. 主设备 发出地址和命令占用总线，使用完后主设备放弃总线，从设备进行准备。

2. 如果 从设备 准备好数据，**从设备会化身为主设备**向总线发出请求

   

## 存储器 

## 输入输出系统

## 计算机的运算方法

## 指令系统

## CPU的结构和功能

## 控制单元的功能

## 控制单元的设计

