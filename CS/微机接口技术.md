# 微机接口技术

## 输入输出系统

### 总线

#### 32位微处理器的外部引脚

理解微处理器的引脚功能是计算机系统中微处理器与存储器和微处理器与I/O接口进行连接的重要基础之一

Pentium微处理器的引脚功能：

1. 数据线及控制信号：

   + $D_{63}\sim D_0$：双向数据线，可以传输8个`Byte`的数据
   + $\overline{BE_7}\sim \overline{BE_0}$：字节允许信号（存储体选中信号），对应8个`Byte`64位数据
   + $DP_7\sim DP_0$：奇偶校验信号，写操作时每个`Byte`产生一个校验位，读操作时则按字节校验
   + $\overline{PCHK}$：读校验出错信号
   + $\overline {PEN}$：奇偶校验允许信号，校验出错时，处理器自动进行异常处理

2. 地址线及控制信号

   + $A_{31}\sim A_3$：高29位地址线，双向地址线，既能对外选择主存和I/O设备，又能对内选择片内Cache单元。能寻址4GB内存和64KB的I/O空间
   + $A_2\sim A_0$：低3位地址组合成字节允许信号$\overline{BE_7}\sim \overline{BE_0}$，所以，$A_2\sim A_0$不对外。
   + $\overline{ADS}$：地址状态输出信号，表示CPU已经启动一个总线周期

3. 总线周期控制信号

   CPU通过总线与存储器、I/O交换一个数据所需要的时间称为总线周期，下面三个信号的组合表示该周期内总线完成的操作

   + $M/\overline{IO}$：1表示CPU与存储器交换信息；0表示CPU与I/O接口交换信息
   + $D/\overline C$：1表示传输的是数据；0表示传输的是指令代码
   + $W/\overline R$：1表示CPU进行写操作；0表示CPU进行读操作

| $\rm M/\overline {IO}$ | $\rm D/\overline {C}$ | $\rm W/\overline R$ | 操作          |
| ---------------------- | --------------------- | ------------------- | ------------- |
| 0                      | 0                     | 0                   | 中断          |
| 0                      | 0                     | 1                   | 中止/专用周期 |
| 0                      | 1                     | 0                   | I/O读         |
| 0                      | 1                     | 1                   | I/O写         |
| 1                      | 0                     | 0                   | 微代码读      |
| 1                      | 0                     | 1                   | 保留          |
| 1                      | 1                     | 0                   | 存储器读      |
| 1                      | 1                     | 1                   | 存储器写      |

4. 系统控制信号

   $CLK$信号是系统时钟信号，其周期称为时钟周期或**T状态**，Pentium的总线周期包含两个时钟周期

   + $INTR$：可屏蔽中断请求信号
   + $NMI$：非屏蔽中断请求信号

5. 总线仲裁信号

   1. $HOLD$：总线请求信号（输入）
   2. $HLDA$：总线请求响应信号（输出）

#### 总线标准

总线是构成计算机系统的互联机构，是多个系统的功能部件之间，进行数据传送的公共通路。通过总线可以传输数据信息、地址信息和各种控制命令和状态信息

总线类型：

1. 按照总线传输的信息性质划分：数据总线，地址总线和控制总线
2. 按照连接对象和所处系统层次：芯片级总线，系统总线，局部总线和外部总线

总线标准：

1. AT（ISA）总线

   工业标准结构(Industry standard architecture，简称ISA）是IBM的标准兼容总线。其数据宽度16位；数据传输率最高8MB/S；一次可进行8位或16位数据存取；24根地址线，可寻址16MB存储空间；64K个可寻址的I/O端口；15级中断控制；7个DMA通道；支持多个主控器

2. EISA总线

3. VESA总线

4. PCI总线

   外围部件互连（Peripheral component interconnect，简称PCI）是Intel公司为奔腾微处理器的开发使用而设计的局部总线。PCI用32位数据传输，也可扩展为64位。用32位数据宽度时，以33MHz的频率运行，传输率可达132MB/s；用64位数据宽度时，以66MHz的频率运行，传输率达 528MB/s。高效率，即插即用，兼容各类总线

5. 并行I/O标准接口IDE

   IDE (Integrated Drive Electronics )也称为ATA（AT Attachable）IDE即“电子集成驱动器”，它的本意是指把“硬盘控制器”与“盘体”集成在一起的硬盘驱动器。把盘体与控制器集成在一起的做法减少了硬盘接口的电缆数目与长度，数据传输的可靠性得到了增强，硬盘制造起来变得更容易。对用户而言，硬盘安装起来也更为方便。

6. SATA（Serial ATA）

   使用SATA（Serial ATA）口的硬盘又叫串口硬盘，是PC机硬盘的趋势。SATA采用串行连接方式，嵌入式时钟信号，具备了更强的纠错能力，与以往相比其最大的区别在于能对传输指令（不仅仅是数据）进行检查，如果发现错误会自动矫正，这在很大程度上提高了数据传输的可靠性。串行接口还具有结构简单、支持热插拔的优点。

7. 通用串行总线USB

   USB用一个4针插头作为标准插头，采用菊花链形式可以把所有的外设连接起来，最多可以连接127个外部设备，并且不会损失带宽。USB需要主机硬件、操作系统和外设三个方面的支持才能工作。目前的主板一般都采用支持USB功能的控制芯片组，USB支持热插拔，连接灵活，独立供电等优点，可以连接鼠标、键盘、打印机、扫描仪、摄像头、闪存盘等，几乎所有的外部设备。

### 输入输出系统概述

#### 输入输出接口

接口电路的作用：由于输入输出设别的多样性和接口电路的复杂性，CPU必须通过接口电路与外设进行信息交换。所以称接口是CPU与外部设备交换信息的中转站

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20221120152004.png" alt="image-20221120151957038" style="zoom:80%;" />

接口电路的功能：

1. 数据缓冲功能：一般设置有数据缓冲器（输入）或锁存器（输出），以实现系统内外信号隔离和信号稳定
2. 寻址功能：应有I/O端口地址译码器，以便使用输入输出的指令来读写数据
3. 联络功能：在CPU和外设之间传递对方的状态
4. 中断管理功能：为了便于CPU和端口寄存器交换信息。应有中断控制电路，允许或禁止接口电路提出中断请求
5. 数据转换功能：计算机内部是并行处理数据，但有些外设只支持串行处理数据。所以应具有“串转并”和“并转串”

#### 端口

**端口**是接口电路中，能与CPU交换信息(使用`IN`和`OUT`) 的**寄存器**，即输入输出端口寄存器，简称为端口。每个端口，系统都为其提供一个地址，系统只要给出某个地址，通过译码电路，就能找到响应的I/O接口电路中的端口寄存器。

端口的分类：

+ 数据口：存放CPU向外设输出或外设输入的数据（注意，接口电路**必须具有数据口**）
+ 控制口：存放控制信息（控制接口电路、外设的工作）
+ 状态口：存放状态信息（反映外设的状态）

端口的编制方式：

1. **存储器映像方式**：把端口和存储单元等同看待，统一编址
   + 凡访问存储单元的指令都可访问I/O端口
   + 端口地址占用**存储空间**
2. **端口独立编址方式**：I/O端口和存储器分别使用两个地址空间, 单独编址
   + I/O 端口不占用存储空间
   + CPU要有专用的 I/O 指令

PC系列机的端口变址采用**端口独立编址**的方式，设计用$A_{15}\sim A_0$低16位地址寻址I/O端口。通过总线周期控制信号$M/\overline{IO}$切换访问I/O端口和存储器。但基于微处理器的PC系列机，实际使用$A_9\sim A_0$作为I/O地址，所以实际端口地址最多为$2^{10} = 1024$，其中系统本身占用一部分。此外，**输入输出空间无分段概念**

#### 常用的I/O指令

上文提到，采用独立编址方式时需要有专门的指令用以访问

当端口地址为**1字节**，可以采用直接寻址的方式，寻址最多$2^8 = 256$个端口：

1. `IN`

   格式：`IN AL/AX/EAX,PORT`

   功能：将端口地址为`PORT`的内容输入到寄存器中，因为`IN`每次只能传递一个字节。所以寄存器的大小会改变其表现形式：

   + `AX`：将`[PORT]`传递给`AL`，将`[PORT+1]`传递给`AH`
   + `EAX`：将`[PORT]~[PORT+3]`的内容从低到高依次传递

2. `OUT`

   格式：`OUT PORT,AL/AX/EAX`

   功能：将对应寄存器内容输出到某个端口地址，与`IN`相同，传递信息的大小根据寄存器的大小而改变。同样也是**底对低高对高**地传递

当端口地址为**2字节**，可以用间接寻址方式，寻址最多$2^{16}$个端口，注意端口地址必须放在寄存器`DX`中，且`DX`**无方括号**。传递信息的大小同样根据寄存器的大小而改变。同样也是**底对低高对高**地传递

1. `IN`

   格式：`IN AL/AX/EAX,DX`

   功能：将`[DX]`的端口内容传递给对应寄存器

2. `OUT`

   格式：`OUT DX,AL/AX/EAX`

   功能：将寄存器中的内容输出到`[DX]`的端口寄存器

### 交换信息的四种方式

#### 无条件传送方式

##### 输入接口

执行`IN`指令之前，要求外设数据已经准备好

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20221120192023.png" alt="image-20221120192023895" style="zoom:80%;" />

+ 三态门即三态缓冲器，其拥有三个输出：0，1以及高阻
+ 当CPU未执行输入指令时，$\overline {IOR}$为0，此时三态缓冲器成高阻状态。以实现内部和外部数据总线隔离，反之数据则通过三态缓冲器到达数据总线

##### 输出接口

执行`OUT`指令之前, 须保证输出设备空闲。

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20221120192415.png" alt="image-20221120192415514" style="zoom:80%;" />

在无条件输出时，由于外设的速度较慢。所以输出端用锁存器（8个D触发器）和CPU的数据总线相连。注意：必须保证锁存器中是空闲的。执行`OUT`指令时：

+ `AL\AX\EAX`的内容$\to$数据线
+ 端口地址$\to$地址线
+ $\overline{LOW}=0$有效，CPU输出的数据经过数据总线送入输出锁存器，$\overline{LOW}$有效状态结束后，输出锁存器一直保持这个数据直到被外设取走。如果上一次的数据未及时取走，则新输入的数据改变上一次的数据就会造成数据丢失

#### 查询方式

用查询方式交换信息，必先了解外设的状态，也就是必须得有状态口

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20221120194454.png" alt="image-20221120194454708" style="zoom:80%;" />

其用汇编表示的核心程序如下：

```asm
;状态口地址=200H
;数据口地址=201H
;输入程序
RSCAN: 
MOV    DX, 200H
IN     AL, DX
TEST   AL, 80H;状态口D_7为1,表示输入数据已经准备好
JZ     RSCAN
MOV    DX, 201H
IN     AL, DX
```

```asm
;状态口地址=200H=数据口地址
;输出程序
TSCAN:  
MOV    DX,200H
IN     AL,DX
TEST   AL,1;状态口D_0为0,表示空闲
JNZ    TSCAN
MOV    DX,200H
MOV    AL,Number
OUT    DX,AL
```

在查询方式中，显然CPU一直在查询，效率低下。且在有多个外设的系统中，多个外设要求CPU为它服务是**随机的**，就不能保证系统实时地对外设的请求作出响应。

#### 中断控制方式

在外设没有作好数据传送准备时，CPU可执行与传送数据无关的其它指令。当外设作好传送准备后，**主动**向CPU请求中断。若CPU响应这一请求，则暂停正在运行的程序，转入中断服务程序，完成数据传送。待服务完毕后，自动返回原来运行的程序

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20221120201152.png" alt="image-20221120201152833" style="zoom:67%;" />

+ 被中断的原程序称为主程序
+ 中断处理程序称为中断服务子程序
+ 主程序被中止的地方，称为断点，也就是下一条指令所在内存的地址

#### DMA方式

DMA (Direct Memory Access) : 直接存储器存取，习惯上称DMA传送。利用硬件完成高速外设与系统RAM之间的信息交换。DMAC 是实现DMA传送的核心芯片

+ DMA读传送: 在DMAC控制下，读取RAM的内容传送到I/O端口
+ DMA写传送: 在DMAC控制下，I/O端口信息传送到系统RAM某单元
+ 存储单元读/写传送： 在DMAC控制下，实现系统RAM之间的传送

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20221120201839.png" alt="image-20221120201839529" style="zoom:80%;" />

+ 系统的三总线分别受到CPU和DMAC的控制。但同一时间, 三总线只能受一个器件的控制。所以, 两者之间必须有联络信号

##### DMA传送过程

1. 高速外设通过其接口电路向DMAC发出“DMA请求”信号 (请求DMAC为其传送数据)

2. DMAC检测到有DMA请求之后, 即向CPU提出“总线保持请求”`HOLD`信号 (请求CPU脱离总线)

3. CPU执行完当前指令的当前总线周期之后脱离系统总线，并向DMAC发出“总线响应”HLDA信号

4. DMAC收到“总线响应”信号之后，**接管系统总线的控制权**，并向I/O接口发出“DMA响应”信号

5. 在这之后，由DAMC控制系统总线，进行DMA传送

   1. 若进行DMA读传送：

      DMAC把RAM地址$\to$地址总线上

      DMAC发出存储器读命令和I/O写命令

   2. 若进行DMA写传送：

      DMAC把RAM地址$\to$地址总线上

      DMAC发出I/O读命令和存储器写命令

6. 预定的字节数全部传送完毕，DMAC脱离系统总线，CPU再次控制系统总线，完成被中断指令的后继总线周期

##### DMA传送与中断方式的比较

1. 响应时间：CPU接到“中断请求”后要等到**当前指令执行完毕**才响应，而CPU接到DMAC的“总线请求”后，只要**当前指令的当前总线周期执行完毕**就响应
2. 传输速度：DMAC传送比中断传送要快

3. 中断传送是由**软件**完成的，执行一次中断服务程序，就完成一字节的 I/O 传送。 而DMA传送是由**硬件**完成的，每传送一个字节只占用CPU的一个总线周期。
4. 中断请求分为**内部中断和外部中断**。DMA请求的方式分为**硬件DMA请求和软件DMA请求**



**8237A DMA控制器**：在PC机中使用两片这玩意，一片8237有4个DMA通道。8237提供4种DMA传送方式：单字节读/写传送；数据块读/写传送；请求传送；级连传送。一次DMA传送的最大字节数是**64KB**。8237每个通道只能访问64K RAM，PC系列机由于增加了“页面寄存器”，所以一个通道能访问16M内存

#### 传送方式比较

|    传送方式    |                           **优点**                           | **缺点**                                         |
| :------------: | :----------------------------------------------------------: | ------------------------------------------------ |
| 无条件传送方式 |   可以直接使用输入缓冲器或锁存器与数据线相连，程序设计简单   | 传送不能太频繁（保证每次传送设备都处在就绪状态） |
|    查询方式    |                     比无条件传送方式可靠                     | 降低了CPU的工作效率，不具有实时性                |
|  中断控制方式  | 提高了CPU的工作效率，具备实时性，可并行工作，不用反复查询外设的工作状态。 | 每次进行数据传输，都要保存现场                   |
|    DMA方式     |           按数据块传输，不经过CPU，不需要保护现场            | 硬件更复杂（DMA控制器）                          |



